<h1>Bots</h1>

<canvas id="cnv" width=300 height=200></canvas>
<script>
speed = 4
friction = 0
logLevel = 1

var ws = new WebSocket("ws://"+document.location.host+"/ws")
ws.onopen = function() {
	console.log("Connected")
}

targetId = null

entities = {}
ws.onmessage = function(data) {
	cmd = JSON.parse(data.data);
	if (logLevel>1) console.log(cmd);
	switch (cmd[0]) {
		case "NEW":
			switch (cmd[2]) {
				case "PLAYER":
				console.log("Creating entity", cmd[1]) 
				entities[cmd[1]] = {
					id:cmd[1],
					xspeed:0, yspeed:0, x:0,y:0,
					step:stepPlayer,
					render:renderOtherPlayer}
				break;
				default:
				console.log("Unknown type", cmd[2]);
				break
			}
		break;
		case "CONTROL":
			console.log("Controlling entity", cmd[1])
			targetId = cmd[1]
			entities[targetId].render = renderPlayer
		break;
		case "MOVE":
			e = entities[cmd[1]]
			if (cmd[1] != targetId) {
				e.x =  cmd[2]
				e.y =  cmd[3]
				e.xspeed = cmd[4]
				e.yspeed = cmd[5] 
			}
			break;
		case "PING":
			ws.send(JSON.stringify(["PONG"]))
		break
		case "SAY":
		break;
		case "DEL":
			delete entities[cmd[1]];
		break;
	}
}
function lerp(a,b,r) { return a+(b-a)*r }

function renderOtherPlayer(player, ctx, ratio) {
	x = player.x - player.xspeed + player.xspeed * ratio
	y = player.y - player.yspeed + player.yspeed * ratio
	ctx.fillStyle="orange";
	ctx.fillRect(x-3,y-3,6, 6);
}
function renderPlayer(player, ctx, ratio) {
	x = player.x - player.xspeed + player.xspeed * ratio
	y = player.y - player.yspeed + player.yspeed * ratio
	ctx.fillStyle="blue";
	ctx.fillRect(x-4,y-4,8, 8);
}

function stepPlayer(player) {
	player.x += player.xspeed
	player.y += player.yspeed

	var canvas = document.getElementById('cnv');
	if (target.x<3) {
		target.x=3 
		target.xspeed = 0
	}
	if (target.x>canvas.width-3) {
		target.x = canvas.width-3
		target.xspeed = 0
	}
	if (target.y<3) {
		target.y=3
		target.yspeed = 0
	}
	if (target.y>canvas.height-3) {
		target.y = canvas.height-3
		target.yspeed = 0
	}
}

lastLogic = (new Date())
function render() {
	lerpAmount = ((new Date())-lastLogic)/40
	var canvas = document.getElementById('cnv');
	ctx = canvas.getContext('2d');

	ctx.fillStyle="white";
	ctx.fillRect(0,0,canvas.width,canvas.height);
	ctx.strokeStyle="black";
	ctx.strokeRect(0,0,canvas.width,canvas.height);


	for (var key in entities) {
	  if (entities.hasOwnProperty(key)) {
	    entities[key].render(entities[key], ctx, lerpAmount)
	  }
	}
}

keys = {up:false,down:false,left:false,right:false}

function logic() {
	lastLogic = (new Date())
	if (targetId!=null) {
		target = entities[targetId]

		oldX = target.x
		oldY = target.y
		oldXspeed = target.xspeed
		oldYspeed = target.yspeed
		target.xspeed *= friction
		target.yspeed *= friction
		if (Math.abs(target.xspeed)<.01) target.xspeed=0
		if (Math.abs(target.yspeed)<.01) target.yspeed=0

		if (keys.up>0) target.yspeed = -speed
		if (keys.down>0) target.yspeed = speed
		if (keys.left>0) target.xspeed = -speed
		if (keys.right>0) target.xspeed = speed


		if (target.x!=oldX || target.y!=oldY || target.xspeed!=oldXspeed || target.yspeed!=oldYspeed) {
			dat = ["MOVE",targetId,target.x,target.y,target.xspeed, target.yspeed]
			ws.send(JSON.stringify(dat))
		}
	}
	for (var key in entities) {
	  if (entities.hasOwnProperty(key)) {
	    entities[key].step(entities[key])
	  }
	}

	if (keys.up==1) {
		keys.up = 0
	}
	if (keys.down==1) {
		keys.down = 0
	}
	if (keys.left==1) {
		keys.left = 0
	}
	if (keys.right==1) {
		keys.right = 0
	}

}
setInterval(logic,40);

document.onkeydown = function(evt) {
    evt = evt || window.event;
	console.log(evt.keyCode);
    switch (evt.keyCode){
    	case 37: case 65: keys.left = 2; break;
    	case 39: case 68: keys.right = 2; break;
    	case 38: case 87: keys.up = 2; break;
    	case 40: case 83: keys.down = 2; break;
    	default: return true;
    }
    return false;
};

document.onkeyup = function(evt) {
    evt = evt || window.event;
	console.log(evt.keyCode);
    switch (evt.keyCode){
    	case 37: case 65: keys.left = 1; break;
    	case 39: case 68: keys.right = 1; break;
    	case 38: case 87: keys.up = 1; break;
    	case 40: case 83: keys.down = 1; break;
    	default: return true;
    }
    return false;
};

(function animloop(){
  window.requestAnimationFrame(animloop);
  render();
})();

</script>
