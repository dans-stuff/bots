<h1>Bots</h1>

<script src="three.js"></script>
<script>



var scene = new THREE.Scene();

var renderer = new THREE.WebGLRenderer();

canvasW = 720
canvasH = 405

renderer.setSize( canvasW, canvasH );
document.body.appendChild( renderer.domElement );

var camera = new THREE.PerspectiveCamera( 75, renderer.domElement.width/renderer.domElement.height, 0.1, 1000 );

var texture = THREE.ImageUtils.loadTexture( "img/grass.png" );
texture.wrapS = THREE.RepeatWrapping;
texture.wrapT = THREE.RepeatWrapping;
texture.repeat.set( 10, 10 );

var geoPlayer = new THREE.BoxGeometry( 6, 6, 6 );
var matOtherPlayer = new THREE.MeshBasicMaterial( { color: 0x222299 } );
var matPlayer = new THREE.MeshBasicMaterial( { color: 0x0000ff } );
var geoFloor = new THREE.PlaneGeometry( -canvasW, canvasH, 30, 20 );
var matFloor = new THREE.MeshBasicMaterial( { map: texture } );



camera.up.set(0,0,-1)
scene.add(camera)
floor = new THREE.Mesh( geoFloor, matFloor)
floor.position.set(canvasW/2,canvasH/2,0)
scene.add(floor)

speed = 4
friction = 0
logLevel = 1

var ws = new WebSocket("ws://"+document.location.host+"/ws")
ws.onopen = function() {
	console.log("Connected")
}

targetId = null

entities = {}
ws.onmessage = function(data) {
	cmd = JSON.parse(data.data);
	if (logLevel>1) console.log(cmd);
	switch (cmd[0]) {
		case "NEW":
			switch (cmd[2]) {
				case "PLAYER":
				newEnt = {
					body:new THREE.Mesh( geoPlayer, matOtherPlayer ),
					id:cmd[1],
					xspeed:0, yspeed:0, x:0,y:0,
					step:stepPlayer,
					render:renderOtherPlayer}
				entities[cmd[1]] = newEnt
				console.log("Creating entity", newEnt) 

				scene.add(entities[cmd[1]].body);
				break;
				default:
				console.log("Unknown type", cmd[2]);
				break
			}
		break;
		case "CONTROL":
			console.log("Controlling entity", cmd[1])
			targetId = cmd[1]
			ent = entities[targetId]
			ent.render = renderPlayer
			scene.remove(ent.body);
			ent.body = new THREE.Mesh( geoPlayer, matPlayer )
			scene.add(ent.body);
		break;
		case "MOVE":
			e = entities[cmd[1]]
			if (cmd[1] != targetId) {
				e.x =  cmd[2]
				e.y =  cmd[3]
				e.xspeed = cmd[4]
				e.yspeed = cmd[5] 
			}
			break;
		case "PING":
			ws.send(JSON.stringify(["PONG"]))
		break
		case "SAY":
		break;
		case "DEL":
			scene.remove(cmd[1].body);
			delete entities[cmd[1]];
		break;
	}
}
function lerp(a,b,r) { return a+(b-a)*r }

function renderOtherPlayer(player, ratio) {
	x = player.x - player.xspeed + player.xspeed * ratio
	y = player.y - player.yspeed + player.yspeed * ratio
	player.body.position.x = x
	player.body.position.y = y
	player.body.position.z = -3
}
function renderPlayer(player, ratio) {
	x = player.x - player.xspeed + player.xspeed * ratio
	y = player.y - player.yspeed + player.yspeed * ratio
	player.body.position.x = x
	player.body.position.y = y
	player.body.position.z = -3
	camera.position.x = (camera.position.x*2+player.body.position.x)/3
	camera.position.y = (camera.position.y*2+player.body.position.y+30)/3
	camera.lookAt(player.body.position);
}

function stepPlayer(player) {
	player.x += player.xspeed
	player.y += player.yspeed

	canvas = renderer.domElement;
	if (target.x<3) {
		target.x=3 
		target.xspeed = 0
	}
	if (target.x>canvas.width-3) {
		target.x = canvas.width-3
		target.xspeed = 0
	}
	if (target.y<3) {
		target.y=3
		target.yspeed = 0
	}
	if (target.y>canvas.height-3) {
		target.y = canvas.height-3
		target.yspeed = 0
	}
}

lastLogic = (new Date())
renderStep = 0
function render() {
	renderStep += 1
	camera.position.z = -50;

	lerpAmount = ((new Date())-lastLogic)/40

	for (var key in entities) {
	  if (entities.hasOwnProperty(key)) {
	    entities[key].render(entities[key], lerpAmount)
	  }
	}

	renderer.render(scene, camera);
}

keys = {up:false,down:false,left:false,right:false}

function logic() {
	lastLogic = (new Date())
	if (targetId!=null) {
		target = entities[targetId]

		oldX = target.x
		oldY = target.y
		oldXspeed = target.xspeed
		oldYspeed = target.yspeed
		target.xspeed *= friction
		target.yspeed *= friction
		if (Math.abs(target.xspeed)<.01) target.xspeed=0
		if (Math.abs(target.yspeed)<.01) target.yspeed=0

		if (keys.up>0) target.yspeed = -speed
		if (keys.down>0) target.yspeed = speed
		if (keys.left>0) target.xspeed = -speed
		if (keys.right>0) target.xspeed = speed


		if (target.x!=oldX || target.y!=oldY || target.xspeed!=oldXspeed || target.yspeed!=oldYspeed) {
			dat = ["MOVE",targetId,target.x,target.y,target.xspeed, target.yspeed]
			ws.send(JSON.stringify(dat))
		}
	}
	for (var key in entities) {
	  if (entities.hasOwnProperty(key)) {
	    entities[key].step(entities[key])
	  }
	}

	if (keys.up==1) {
		keys.up = 0
	}
	if (keys.down==1) {
		keys.down = 0
	}
	if (keys.left==1) {
		keys.left = 0
	}
	if (keys.right==1) {
		keys.right = 0
	}

}
setInterval(logic,40);

document.onkeydown = function(evt) {
    evt = evt || window.event;
	console.log(evt.keyCode);
    switch (evt.keyCode){
    	case 37: case 65: keys.left = 2; break;
    	case 39: case 68: keys.right = 2; break;
    	case 38: case 87: keys.up = 2; break;
    	case 40: case 83: keys.down = 2; break;
    	default: return true;
    }
    return false;
};

document.onkeyup = function(evt) {
    evt = evt || window.event;
	console.log(evt.keyCode);
    switch (evt.keyCode){
    	case 37: case 65: keys.left = 1; break;
    	case 39: case 68: keys.right = 1; break;
    	case 38: case 87: keys.up = 1; break;
    	case 40: case 83: keys.down = 1; break;
    	default: return true;
    }
    return false;
};

(function animloop(){
  window.requestAnimationFrame(animloop);
  render();
})();

</script>
